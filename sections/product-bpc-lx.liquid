{% comment %}
  ============================================================
  CUSTOM SECTION: Product BPC-LX Layout
  ============================================================
  This is a duplicated section from product.liquid specifically
  for the BPC-LX product template (product.bpc-lx.json).

  You can now modify this section independently without affecting
  the default product template.

  Schema Name: "Product pages - BPC-LX"
  Template: templates/product.bpc-lx.json
  ============================================================
{% endcomment %}

{% comment %} {% if product.tags contains 'hide' or product.tags contains 'Hide' %}
  <script>
    window.location.href = '/collections/all';
  </script>
{% endif %} {% endcomment %}
{%- assign current_variant = product.selected_or_first_available_variant -%}

<div id="product" class="product {{ template.suffix }}">
  {%- unless template == 'index' or template == 'cart' or template == 'list-collections' or template == '404' -%}
    {% comment %} {%- assign t = template | split: '.' | first -%} {% endcomment %}
  {%- endunless -%}

  <!-- Product Title (Mobile Only) -->
  <div class="container-1220 product-header product-header-mobile"
    data-aos="fade-up" 
    data-aos-duration="3000"
    data-aos-once="true"
  >
    <div class="breadcrumb hide" role="navigation" aria-label="breadcrumbs">
      {% assign full_url = request.path %}
      {% assign product_url = full_url | split: '/' %}

      <a href="{{ routes.root_url }}" class="breadcrumb-link">Home</a>
      <span> / </span>

      {% if product_url[1] == 'collections' and collections[product_url[2]] %}
        <a href="{{ collections[product_url[2]].url }}" title="{{ collections[product_url[2]].title }}" class="breadcrumb-link">
          {{ collections[product_url[2]].title }}
        </a>
        <span> / </span>
      {% elsif product.collections.size > 0 %}
        <a href="{{ product.collections.first.url }}" title="{{ product.collections.first.title }}" class="breadcrumb-link">
          {{ product.collections.first.title }}
        </a>
        <span> / </span>
      {% endif %}

      <span class="breadcrumb-text">{{ product.title }}</span>
    </div>
    <h1 class="js__pdp-title uppercase small product-title">
      {% if product.metafields.custom.alternate_title != blank %}
        {{ product.metafields.custom.alternate_title }}
      {% else %}
        {{ product.title }}
      {% endif %}
    </h1>

    <!-- Product Short Description -->
    {% if product.metafields.product.short_description != blank %}
      <div class="description product-description">
        <p>
          {{ product.metafields.product.short_description }}
        </p>
      </div>
    {% endif %}

    <!-- Reviews -->
    <div class="product-reviews-summary">
      {% render 'okendo-reviews-product-rating-summary', product: product %}
    </div>
  </div>

  <div class="container-1220 flex-wrap product-content"
      data-aos="fade-up" 
      data-aos-duration="3000"
      data-aos-once="true"
  >
    <!-- Product Media -->
    <div class="left-section"
    >
      {% include 'product_images' %}
      <!-- Thumbnail expand/collapse button for bpc-lx -->
      <button class="bpc-lx-thumbnail-toggle hide" type="button" aria-label="Toggle thumbnail gallery">
        <span class="toggle-icon-plus">{% render 'icon-toggle-plus' %}</span>
        <span class="toggle-icon-minus">{% render 'icon-toggle-minus' %}</span>
      </button>
    </div>

    <!-- Right Product Information Section -->
    <div
      class="product__information"
      id="ProductSection"
      data-section-id="{{ section.id }}"
      data-section-type="product-template"
      data-image-zoom-type="{{ section.settings.product_image_zoom_type }}"
      data-extra-tab-content="{{ section.settings.extra_tab_content }}"
      data-enable-history-state="true"
    >
      <!-- Product Header (Desktop Only) -->
      <div class="product-header product-header-desktop">
        <div class="breadcrumb hide" role="navigation" aria-label="breadcrumbs">
          {% assign full_url = request.path %}
          {% assign product_url = full_url | split: '/' %}

          <a href="{{ routes.root_url }}" class="breadcrumb-link">Home</a>
          <span> / </span>

          {% if product_url[1] == 'collections' and collections[product_url[2]] %}
            <a href="{{ collections[product_url[2]].url }}" title="{{ collections[product_url[2]].title }}" class="breadcrumb-link">
              {{ collections[product_url[2]].title }}
            </a>
            <span> / </span>
          {% elsif product.collections.size > 0 %}
            <a href="{{ product.collections.first.url }}" title="{{ product.collections.first.title }}" class="breadcrumb-link">
              {{ product.collections.first.title }}
            </a>
            <span> / </span>
          {% endif %}

          <span class="breadcrumb-text">{{ product.title }}</span>
        </div>
        <h1 class="js__pdp-title uppercase small product-title">
          {% if product.metafields.custom.alternate_title != blank %}
            {{ product.metafields.custom.alternate_title }}
          {% else %}
            {{ product.title }}
          {% endif %}
        </h1>

        <!-- Reviews -->
        <div class="product-reviews-summary">
          {% render 'okendo-reviews-product-rating-summary', product: product %}
        </div>

        <!-- Product Short Description -->
        {% if product.metafields.product.short_description != blank %}
          <div class="description product-description">
            <p>
              {{ product.metafields.product.short_description }}
            </p>
          </div>
        {% endif %}

      </div>

      <!-- Price - Hidden -->
      <div class="flex-column price__wrapper hide">
        {% comment %} Price {% endcomment %}
        <div class="">
          <div
            class="product-single__prices"
            content="{{ current_variant.price | divided_by: 100.00 }}"
          >
            {% if product.price < product.compare_at_price %}
              <span>{{ product.price | money }}</span> <s>{{ product.compare_at_price | money }}</s>
            {% else %}
              <span> {{ product.price | money }}</span>
            {% endif %}
          </div>
        </div>
      </div>

      <a href="#" class="hide link--secondary ">View Ingredients & Nutrition Facts</a>
      {% comment %} Form {% endcomment %}
       <div class="product-benefits_section">
          <div class="product-benefits_section_inner_content">
            {% assign benefit_items = "LipoEmulsionâ„¢ tasteless fine mist,Bypasses digestion for rapid onset,cGMP manufactured in the USA,3rd-party tested by ISO-Certified Labs,FAQs|Supplement Facts" | split: "," %}
            {% assign benefit_icons = "icon-mist-02.svg,flash.svg,icon-usa.svg,icon-microscope.svg,icon-question.svg" | split: "," %}
            {% for item_text in benefit_items %}
              {% assign icon_name = benefit_icons[forloop.index0] %}
              <div class="inner-content">
                <div class="title">
                  <img src="{{ icon_name | asset_url }}" alt="{{ icon_name | replace: 'icon-', '' | replace: '.svg', '' }}" width="24" height="24">
                  <span>
                    {% if item_text contains '3rd-party tested' and section.settings.iso_certified_labs_url != blank %}
                      {% assign text_parts = item_text | split: '3rd-party tested' %}
                      {{ text_parts[0] }}<a href="{{ section.settings.iso_certified_labs_url }}" rel="noopener">3rd-party tested</a>{{ text_parts[1] }}
                    {% elsif item_text == 'FAQs|Supplement Facts' %}
                      <a href="#product-faq" rel="noopener">FAQs</a> | {% if section.settings.supplement_facts_image != blank %}<a href="#" class="js__supplement-facts-trigger" rel="noopener">Supplement Facts</a>{% else %}Supplement Facts{% endif %}
                    {% else %}
                      {{ item_text }}
                    {% endif %}
                  </span>
                </div>
              </div>
            {% endfor %}
          </div>
       </div>

       {% comment %} Live Stock Display {% endcomment %}
       {% render 'product-stock', product: product, show_icon: true, threshold_low: 10, threshold_high: 50 %}

      <div class="product__form">
        <form
          action="/cart/add"
          id="add-to-cart"
          method="post"
          enctype="multipart/form-data"
          data-productid="{{ product.id }}"
        >


          {% include 'product_linked-options' %}
          {% for block in section.blocks -%}
            {% case block.type %}
              {% when '@app' %}
                {% render block %}
            {% endcase %}
          {%- endfor %}
          <div class="hide">
            <select id="product-select" name="id" style="display: none;">
              {% for variant in product.variants %}
                {% if variant.available %}
                  <option
                    {% if variant == current_variant %}
                      selected="selected"
                    {% endif %}
                    value="{{ variant.id }}"
                  >
                    {{ variant.title }}
                  </option>
                {% else %}
                  <option value="{{ variant.id }}">{{ variant.title }} - sold out!</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>

          <div class="product__actions flex">
            <div class="product-single__quantity js-product-single__quantity js-quantity-hide">
              <span class="hide">Qty</span>
              <div class="quantity-outer " data-children-count="1">
                <a class="minus-qty js-plus-minus-qty" data-type="minus">{% include 'icon-minus' %}</a>
                <input
                  type="number"
                  class="quantity-selector js-quantity-selector"
                  value="1"
                  id="Quantity"
                  name="quantity"
                  min="1"
                >
                <a class="plus-qty js-plus-minus-qty" data-type="plus">{% include 'icon-plus' %}</a>
              </div>
            </div>
            <div class="add-to-cart">
              <button
                type="submit"
                name="add"
                id="add"
                class="btn--primary btn--with-arrow"
                onclick="addItem('add-to-cart'); return false;"
              >
                <span>Add to Cart</span>
                <svg
                  width="18"
                  height="14"
                  viewBox="0 0 18 14"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  class="btn-arrow-icon">
                  <path d="M11.0391 0L9.96094 1.07812L14.8828 6H0V7.5H14.8828L9.96094 12.4219L11.0391 13.5L18 6.75L11.0391 0Z" fill="currentColor" />
                </svg>
                {% comment %} <span class="pdp-add-to-cart-price"></span> {% endcomment %}
              </button>
              <div class="trigger_disclaimer"></div>
            </div>
          </div>
        </form>
      </div>
      {% comment %} Form ends {% endcomment %}
      {% comment %}
        show success/error message if required.
        This needs to be enabled in js
      {% endcomment %}
      <div id="cart-message"></div>
      {% comment %} Tabs {% endcomment %}

      <section class="pdp-tab-small hide">
        <div class="pdp-tab-small__wrapper">
          <div class="pdp-tab-small__wrapper__head none-980">
            <ul class="flex">
              {% for value in product.metafields['info-small-tabs'].title %}
                {% assign title = product.metafields['info-small-tabs'].title[forloop.index0] %}

                <li class="js__tab-small">
                  <a
                    class="pdp-tab-link"
                    data-attr="{{title |  downcase | remove: ' '}}"
                    id="tab-{{title |  downcase | remove: ' '}}"
                  >
                    {{- title -}}
                  </a>
                </li>
              {% endfor %}
              {% comment %} <a class="tab-link  active" id="tab-small-link-benefits" data-attr="benefits"> benefits </a> {% endcomment %}
            </ul>
          </div>
          <div class="pdp-tab-small__wrapper__content none-980">
            {% for header in product.metafields['info-small-tabs'].title %}
              {% assign title = product.metafields['info-small-tabs'].title[forloop.index0] %}
              {% assign titleid = product.metafields['info-small-tabs'].title[forloop.index0]
                | downcase
                | remove: ' '
              %}
              {% if titleid == 'howtouse' %}
                <div class="pdp-tab-content content how-to-use-tab" id="{{title |  downcase | remove: ' '}}">
                  {% for value in product.metafields.how_to_use.title -%}
                    {% assign title = product.metafields.how_to_use.title[forloop.index0] %}
                    {% assign description = product.metafields.how_to_use.description[forloop.index0] %}
                    {% assign icon = product.metafields.how_to_use.icon[forloop.index0] | first %}
                    <div class="inner-content">
                      <div class="title">
                        <img src="{{ icon.cloudinary_src}}" alt="{{icon.alt }}">
                        <span class="h5">{{ title }}</span>
                      </div>
                      <div class="description">{{ description }}</div>
                    </div>
                  {%- endfor %}
                </div>
              {% else %}
                <div class="pdp-tab-content content" id="{{title |  downcase | remove: ' '}}">
                  {{ product.metafields['info-small-tabs'].description[forloop.index0] }}
                </div>
              {% endif %}
            {% endfor %}
            {% comment %}
              {% if product.metafields.overview_tab_section.heading_black != blank %}
                <div class="tab-content   active" id="benefits" data-attr="tab-small-link-benefits">
                  {% comment %} <a class="accordion-link " id="tab-small-link-benefits" data-attr="benefits">benefits</a> {% endcomment %}
                  <div class="inner-content accordion-con benefits-content-wrapper">
                    {% comment %}
                      <h2 class="h2">


                          <span class="color-grey h2">{{ product.metafields.overview_tab_section.heading_gray }}</span>

                      </h2>
                    {% endcomment %}
                    <div class="benefits-content">
                      {% comment %} {{ product.metafields.info-small-tabs.description }} {% endcomment %}
                      {% comment %}
                        <ul>
                          {% for value in product.metafields.overview_tab_section.title %}
                            {% assign title = product.metafields.overview_tab_section.title[forloop.index0] %}

                            {% assign description = product.metafields.overview_tab_section.description[forloop.index0] %}
                            <li>
                              <h3 class="h5">{{ title }}</h3>
                              <div class="description">
                                {{ description }}
                              </div>
                            </li>
                          {% endfor %}
                        </ul>
                      {% endcomment %}
                    </div>
                  </div>
                </div>
              {% endif %}
            {% endcomment %}
          </div>
          <ul class="accordian js__accordian block-980">
            {% for value in product.metafields['info-small-tabs'].title %}
              {% assign Title = product.metafields['info-small-tabs'].title[forloop.index0] %}
              {% assign titleid = product.metafields['info-small-tabs'].title[forloop.index0]
                | downcase
                | remove: ' '
              %}
              {% assign listContent = product.metafields['info-small-tabs'].description[forloop.index0] %}
              <li class="outer-list">
                <h3 class="h5">{{ Title }}</h3>
                {% if titleid == 'howtouse' %}
                  <div class="content how-to-use-tab">
                    {% for value in product.metafields.how_to_use.title -%}
                      {% assign title = product.metafields.how_to_use.title[forloop.index0] %}
                      {% assign description = product.metafields.how_to_use.description[forloop.index0] %}
                      {% assign icon = product.metafields.how_to_use.icon[forloop.index0] | first %}
                      <div class="inner-content">
                        <div class="title">
                          <img src="{{ icon.cloudinary_src}}" alt="{{icon.alt }}">
                          <span class="h5">{{ title }}</span>
                        </div>
                        <div class="description">{{ description }}</div>
                      </div>
                    {% endfor %}
                    {% comment %} {{ listContent }} {% endcomment %}
                  </div>
                {% else %}
                  <div class="content">
                    {{ listContent }}
                  </div>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>

      </section>
    </div>
    {% comment %} Right section Ends {% endcomment %}
  </div>
</div>

{% comment %} Supplement Facts Modal - Outside product container for proper z-index {% endcomment %}
{% if section.settings.supplement_facts_image != blank %}
  <div id="modal-supplement-facts" style="display: none">
    <div class="modal-content supplement-facts-popup">
      <button class="close js__supplement-facts-close" aria-label="Close supplement facts">
        {% render 'icon-mobile-menu-close' %}
      </button>
      <div class="supplement-facts-image-wrapper">
        <img
          src="{{ section.settings.supplement_facts_image | image_url: width: 1024 }}"
          alt="Supplement Facts"
          width="{{ section.settings.supplement_facts_image.width }}"
          height="{{ section.settings.supplement_facts_image.height }}"
          loading="lazy"
        >
      </div>
    </div>
  </div>
{% endif %}

<span class="hide js__onetimeText">{{ section.settings.onetimeText }}</span>
<span class="hide js__subscribeText">{{ section.settings.subscribeText }}</span>
{% unless product == empty %}
  <script type="application/json" id="ProductJson-{{ section.id }}">
    {{ product | json }}
  </script>
{% endunless %}

{{ 'product-sticky-atc.css' | asset_url | stylesheet_tag }}
<script src="{{'product-sticky-atc.js' | asset_url}}" defer="defer"></script>
{% render 'product-sticky-atc' %}

<!-- BPC-LX Thumbnail Grid Swiper Initialization -->
<script>
  (function() {
    var bpcThumbnailInstance = null;
    var thumbnailClickHandlers = [];
    var sliderChangeHandler = null;

    function hideToggleButton() {
      var toggleButton = document.querySelector('.product.bpc-lx .bpc-lx-thumbnail-toggle');
      if (toggleButton) {
        toggleButton.classList.remove('grid-active');
        toggleButton.style.display = 'none';
      }
    }

    function showToggleButton() {
      var toggleButton = document.querySelector('.product.bpc-lx .bpc-lx-thumbnail-toggle');
      if (toggleButton) {
        toggleButton.classList.add('grid-active');
        toggleButton.style.display = 'flex';
      }
    }

    function setupGradient() {
      var outerContainer = document.querySelector('.product.bpc-lx .outer-pdp-thumbnail-slider');
      if (outerContainer) {
        outerContainer.classList.add('grid-active');
        if (!outerContainer.classList.contains('collapsed') && !outerContainer.classList.contains('expanded')) {
          outerContainer.classList.add('collapsed');
        }
      }
    }

    function cleanupBpcLxThumbnails() {
      // Remove all click event listeners
      thumbnailClickHandlers.forEach(function(handler) {
        if (handler.element && handler.listener) {
          handler.element.removeEventListener('click', handler.listener);
        }
      });
      thumbnailClickHandlers = [];

      // Remove slider change listener
      if (sliderChangeHandler && window.pdpSlider) {
        window.pdpSlider.off('slideChange', sliderChangeHandler);
        sliderChangeHandler = null;
      }

      // Destroy Swiper instance if it exists
      var thumbnailContainer = document.querySelector('.product.bpc-lx .js__pdp-thumbnail-slider');
      if (thumbnailContainer && thumbnailContainer.swiper) {
        thumbnailContainer.swiper.destroy(true, true);
        thumbnailContainer.swiper = null;
      }

      // Clean up wrapper styles
      if (thumbnailContainer) {
        var wrapper = thumbnailContainer.querySelector('.swiper-wrapper');
        if (wrapper) {
          wrapper.style.transform = '';
          wrapper.style.transition = '';
        }
      }

      // Hide toggle button and remove gradient when grid is not active
      hideToggleButton();

      bpcThumbnailInstance = null;
      window.bpcThumbnail = null;
    }
    
    function initBpcLxThumbnails() {
      if (!document.querySelector('.product.bpc-lx')) return;

      var isDesktop = window.innerWidth >= 1279;
      var thumbnailContainer = document.querySelector('.product.bpc-lx .js__pdp-thumbnail-slider');

      if (!thumbnailContainer || typeof Swiper === 'undefined') {
        setTimeout(initBpcLxThumbnails, 100);
        return;
      }

      // IMPORTANT: Only clean up and initialize custom behavior on desktop
      // On mobile, let the default Swiper from _sm-theme.js handle everything
      if (!isDesktop) {
        // Don't interfere with mobile - just hide the toggle button
        hideToggleButton();
        return;
      }

      // Clean up any existing desktop instance first (only runs on desktop now)
      cleanupBpcLxThumbnails();

      // Setup gradient BEFORE thumbnails load (ensure it's ready)
      setupGradient();

      // Wait a bit for main Swiper to initialize
      setTimeout(function() {
        // Double-check we're still on desktop after timeout
        if (window.innerWidth < 1279) {
          cleanupBpcLxThumbnails();
          return;
        }

        // For 2-column grid layout, we'll use CSS Grid for layout
        // and handle interactions manually while keeping Swiper for compatibility
        // Initialize Swiper but disable its layout transforms
        bpcThumbnailInstance = new Swiper('.product.bpc-lx .js__pdp-thumbnail-slider', {
          slidesPerView: 'auto',
          direction: 'vertical',
          spaceBetween: 0,
          freeMode: false,
          watchSlidesProgress: true,
          clickable: true,
          grabCursor: false, // Disable grab cursor since we're using native scroll
          mousewheel: false, // Use native scrolling instead
          // Disable Swiper's transform-based scrolling
          allowTouchMove: false,
          // Let CSS Grid handle the layout
          autoHeight: false,
          observer: true,
          observeParents: true,
          // Prevent Swiper from applying transforms
          on: {
            init: function() {
              // Disable Swiper's transform on the wrapper
              var wrapper = this.el.querySelector('.swiper-wrapper');
              if (wrapper) {
                wrapper.style.transform = 'none !important';
                wrapper.style.transition = 'none';
              }
            },
            resize: function() {
              // Handle resize within Swiper
              var wrapper = this.el.querySelector('.swiper-wrapper');
              if (wrapper) {
                wrapper.style.transform = 'none !important';
                wrapper.style.transition = 'none';
              }
            },
            slideChange: function() {
              // This won't fire with allowTouchMove: false, but kept for compatibility
            }
          }
        });
        
        // Store reference for manual control
        window.bpcThumbnail = bpcThumbnailInstance;

        // Show toggle button now that grid is active
        showToggleButton();

        // Dispatch event to notify that grid is ready
        if (typeof window.dispatchEvent !== 'undefined') {
          window.dispatchEvent(new CustomEvent('bpcGridInitialized'));
        }
        
        // Handle thumbnail clicks manually for grid layout
        var thumbnails = document.querySelectorAll('.product.bpc-lx .pdp-thumbnail .swiper-slide');
        
        function updateThumbnailActive(index, shouldScroll) {
          thumbnails.forEach(function(t) {
            t.classList.remove('swiper-slide-thumb-active');
          });
          if (thumbnails[index]) {
            thumbnails[index].classList.add('swiper-slide-thumb-active');
            // Scroll thumbnail into view only when triggered by user interaction
            if (shouldScroll) {
              thumbnails[index].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
          }
        }
        
        thumbnails.forEach(function(thumb, index) {
          var clickHandler = function(e) {
            e.preventDefault();
            // Each thumbnail maps directly to a slide (1:1 mapping)
            // In a 2-column grid, thumbnails are arranged:
            // Row 1: [0, 1] -> Slides [0, 1]
            // Row 2: [2, 3] -> Slides [2, 3]
            // So thumbnail index = slide index
            var slideIndex = index;
            if (window.pdpSlider) {
              // Use slideToLoop for loop mode, or slideTo for non-loop mode
              if (window.pdpSlider.params.loop) {
                window.pdpSlider.slideToLoop(slideIndex);
              } else {
                window.pdpSlider.slideTo(slideIndex);
              }
            }
            updateThumbnailActive(index, true); // Enable scroll on user click
          };
          
          thumb.addEventListener('click', clickHandler);
          thumbnailClickHandlers.push({ element: thumb, listener: clickHandler });
        });
        
        // Sync thumbnail active state when main slider changes
        if (window.pdpSlider) {
          sliderChangeHandler = function() {
            // Use realIndex when loop is enabled, otherwise use activeIndex
            var activeIndex = (this.params && this.params.loop && typeof this.realIndex !== 'undefined')
              ? this.realIndex
              : (this.activeIndex || 0);
            // Thumbnail index matches slide index (1:1 mapping)
            updateThumbnailActive(activeIndex, true); // Enable scroll on slide change
          };
          
          window.pdpSlider.on('slideChange', sliderChangeHandler);
          
          // Set initial active thumbnail after a short delay to ensure Swiper is ready
          setTimeout(function() {
            if (window.pdpSlider) {
              var initialIndex = (window.pdpSlider.params && window.pdpSlider.params.loop && typeof window.pdpSlider.realIndex !== 'undefined')
                ? window.pdpSlider.realIndex
                : (window.pdpSlider.activeIndex || 0);
              updateThumbnailActive(initialIndex, false); // Disable scroll on initialization
            }
          }, 100);
        }
      }, 300);
    }
    
    // Initialize on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initBpcLxThumbnails);
    } else {
      initBpcLxThumbnails();
    }
    
    // Handle window resize to prevent breaking on desktop
    var resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(function() {
        var isDesktop = window.innerWidth >= 1279;
        var gridIsActive = bpcThumbnailInstance !== null && window.bpcThumbnail !== null;

        // If resized to mobile, clean up desktop instance immediately
        if (!isDesktop && gridIsActive) {
          cleanupBpcLxThumbnails();
          return;
        }

        // If on desktop and grid is active, update instance
        if (isDesktop && gridIsActive) {
          // Update the Swiper instance to recalculate dimensions
          bpcThumbnailInstance.update();

          // Ensure wrapper styles are maintained after resize
          var thumbnailContainer = document.querySelector('.product.bpc-lx .js__pdp-thumbnail-slider');
          if (thumbnailContainer) {
            var wrapper = thumbnailContainer.querySelector('.swiper-wrapper');
            if (wrapper) {
              wrapper.style.transform = 'none !important';
              wrapper.style.transition = 'none';
            }
          }
        } else if (isDesktop && !gridIsActive) {
          // If on desktop but grid is not active, try to initialize
          initBpcLxThumbnails();
        }
      }, 250);
    });
  })();
</script>

<!-- BPC-LX Thumbnail Toggle Button -->
<script>
  (function() {
    var toggleButtonHandler = null;

    function initThumbnailToggle() {
      var toggleButton = document.querySelector('.product.bpc-lx .bpc-lx-thumbnail-toggle');
      var thumbnailContainer = document.querySelector('.product.bpc-lx .outer-pdp-thumbnail-slider');

      if (!toggleButton || !thumbnailContainer) {
        return;
      }

      // Only setup if grid is active (checked by parent script)
      var gridIsActive = window.bpcThumbnail !== null && window.bpcThumbnail !== undefined;
      if (!gridIsActive) {
        return;
      }

      // Remove any existing event listener by cloning the button
      if (toggleButtonHandler) {
        var oldToggleButton = toggleButton;
        toggleButton = toggleButton.cloneNode(true);
        oldToggleButton.parentNode.replaceChild(toggleButton, oldToggleButton);
        toggleButtonHandler = null;
      }

      // Toggle functionality
      toggleButtonHandler = function(e) {
        // Prevent event bubbling and ensure we catch all clicks on button and children
        e.preventDefault();
        e.stopPropagation();

        if (thumbnailContainer.classList.contains('collapsed')) {
          // Expand
          thumbnailContainer.classList.remove('collapsed');
          thumbnailContainer.classList.add('expanded');
          toggleButton.classList.add('expanded');
        } else {
          // Collapse - ONLY scroll to top when explicitly collapsing via button click
          thumbnailContainer.classList.remove('expanded');
          thumbnailContainer.classList.add('collapsed');
          toggleButton.classList.remove('expanded');

          // Scroll to the top of the page (only on collapse action)
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      };

      toggleButton.addEventListener('click', toggleButtonHandler);
    }

    // Listen for grid initialization event (dispatched by grid script)
    window.addEventListener('bpcGridInitialized', function() {
      initThumbnailToggle();
    });
  })();
</script>

<!-- Supplement Facts Modal -->
<script>
  (function() {
    function initSupplementFactsModal() {
      var modal = document.getElementById('modal-supplement-facts');
      var triggers = document.querySelectorAll('.js__supplement-facts-trigger');
      var closeBtn = document.querySelector('.js__supplement-facts-close');

      if (!modal || triggers.length === 0) return;

      function openModal() {
        modal.style.display = 'flex';
        // Add class after a small delay to trigger CSS transition
        setTimeout(function() {
          modal.classList.add('modal-opened');
        }, 10);
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
      }

      function closeModal() {
        modal.classList.remove('modal-opened');
        // Wait for transition to complete before hiding
        setTimeout(function() {
          modal.style.display = 'none';
        }, 300);
        document.body.style.overflow = ''; // Restore scrolling
      }

      // Open modal when trigger is clicked
      triggers.forEach(function(trigger) {
        trigger.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          openModal();
        });
      });

      // Close modal when close button is clicked
      if (closeBtn) {
        closeBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          closeModal();
        });
      }

      // Close modal when clicking outside the modal content
      modal.addEventListener('click', function(event) {
        // Check if click is on the modal overlay (not on modal-content or its children)
        if (event.target === modal || !event.target.closest('.modal-content')) {
          closeModal();
        }
      });

      // Close modal on ESC key press
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.classList.contains('modal-opened')) {
          closeModal();
        }
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSupplementFactsModal);
    } else {
      initSupplementFactsModal();
    }
  })();
</script>

{% schema %}
{
  "name": "Product pages - BPC-LX",
  "settings": [
    {
      "type": "checkbox",
      "id": "product_quantity_enable",
      "label": {
        "en": "Show quantity selector"
      }
    },
    {
      "type": "header",
      "content": {
        "en": "Product options form (Not being used)"
      }
    },
    {
      "type": "checkbox",
      "id": "enable_payment_button",
      "label": {
        "en": "Show dynamic checkout button"
      },
      "info": {
        "en": "Each customer will see their preferred payment method from those available on your store, such as PayPal or Apple Pay. [Learn more](https://help.shopify.com/manual/using-themes/change-the-layout/dynamic-checkout)"
      },
      "default": true
    },
    {
      "type": "header",
      "content": {
        "en": "Product Recharge Info"
      }
    },
    {
      "type": "text",
      "id": "onetimeText",
      "label": "Onetime Info"
    },
    {
      "type": "text",
      "id": "subscribeText",
      "label": "Subscribe info"
    },
    {
      "type": "url",
      "id": "iso_certified_labs_url",
      "label": "3rd-party tested URL",
      "info": "URL for the 3rd-party tested link in the product benefits section"
    },
    {
      "type": "header",
      "content": "Supplement Facts"
    },
    {
      "type": "image_picker",
      "id": "supplement_facts_image",
      "label": "Supplement Facts Image",
      "info": "Image to display in the Supplement Facts popup modal"
    }
  ]
  ,
  "blocks": [
    {
      "type": "@app"
    }
  ],
  "presets": [
    {
      "name": "Product Information - BPC-LX"
    }
  ]
}
{% endschema %}
{% if template contains 'product' %}
  {% assign selected_variant = product.selected_or_first_available_variant | default: product.variants.first %}
  {% assign product_image = selected_variant.featured_image | default: product.featured_image %}
  {%- capture product_name -%}
        {{ product.title }}
        {%- if selected_variant.title != 'Default Title' and selected_variant.option1 == 'Default Title' -%}
          - {{ selected_variant.title }}
        {%- endif -%}
      {%- endcapture -%}
  {%- assign now = 'now' | date: '%Y-%m-%d' | split: '-' -%}
  {% capture year_from_now %}{{ now[0] | plus: 1 }}-{{ now[1] }}-{{ now[2] | at_most: 28 }}{% endcapture %}
  <script type="application/ld+json">
      {
            "@context": "https://schema.org/",
            "@type": "Product",
            "url": "{{shop.secure_url | escape}}{{ product.url | escape }}",
            "name": {{ product_name | strip_newlines | json }},
            "image": {{ product_image | img_url: '1024x1024' | prepend: 'https:' | json }},
            "gtin12": {{ selected_variant.barcode | json }},
            "description": {% if product.description == '""' or product.description == '' %}
                {{ product.title | json }}
              {% else %}
                {{ product.description | strip_html | json }}
              {% endif %},

              {% if product.vendor %}
              "brand": {
                "@type": "Brand",
                "name": {{ product.vendor | json }}
              },
            {% endif %}
            {% if selected_variant.sku != blank %}
        "sku": {{ selected_variant.sku | json }},
      {% endif %}
      {% if selected_variant.barcode != blank %}
      "mpn": {{ selected_variant.barcode | json }},
    {% endif %}
    "offers": {
      "@type": "Offer",
      "priceCurrency": {{ cart.currency.iso_code | json }},
      "price": {{ selected_variant.price | divided_by: 100.0 | json }},
      "availability": "http://schema.org/{% if selected_variant.available %}InStock{% else %}OutOfStock{% endif %}",
      "url": "{{ shop.url }}{{ selected_variant.url }}",
      "seller": {
        "@type": "Organization",
        "name": {{ shop.name | json }}
      },
      "priceValidUntil": {{ year_from_now | json }},
      {% assign price = selected_variant.price | divided_by: 100.0 %}
      {% if price >= 75 %}
        "shippingDetails": {
          "@type": "OfferShippingDetails",
          "shippingRate": {
            "@type": "MonetaryAmount",
            "value": 0,
            "currency": "USD"
          },
          "shippingDestination": {
            "@type": "DefinedRegion",
            "addressCountry": "US"
          },
          "deliveryTime": {
            "@type": "ShippingDeliveryTime",
            "handlingTime": {
              "@type": "QuantitativeValue",
              "minValue": 0,
              "maxValue": 1,
              "unitCode": "DAY"
            },
            "transitTime": {
              "@type": "QuantitativeValue",
              "minValue": 3,
              "maxValue": 4,
              "unitCode": "DAY"
            }
          }
        },
      {% else %}
        "shippingDetails": {
          "@type": "OfferShippingDetails",
          "shippingRate": {
            "@type": "MonetaryAmount",
            "value": 4.95,
            "currency": "USD"
          },
          "shippingDestination": {
            "@type": "DefinedRegion",
            "addressCountry": "US"
          },
          "deliveryTime": {
            "@type": "ShippingDeliveryTime",
            "handlingTime": {
              "@type": "QuantitativeValue",
              "minValue": 0,
              "maxValue": 1,
              "unitCode": "DAY"
            },
            "transitTime": {
              "@type": "QuantitativeValue",
              "minValue": 3,
              "maxValue": 4,
              "unitCode": "DAY"
            }
          }
        },
      {% endif %}
      "hasMerchantReturnPolicy": {
        "@type": "MerchantReturnPolicy",
        "applicableCountry": "US",
        "returnPolicyCategory": "https://schema.org/MerchantReturnFiniteReturnWindow",
        "merchantReturnDays": 30,
        "returnMethod": "https://schema.org/ReturnByMail",
        "returnFees": "https://schema.org/FreeReturn"
      }
    }
    {% if product.metafields.reviews.rating_count and product.metafields.okendo.summaryData.reviewAverageValue != "0" %}
    ,"aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": {{ product.metafields.okendo.summaryData.reviewAverageValue }},
        "reviewCount": {{ product.metafields.reviews.rating_count }},
        "bestRating": 5,
        "worstRating": 1
    }
    {% endif %}
      }
  </script>
{% endif %}
<span class="js__productid" data-id="{{product.id }}"></span>

{% stylesheet %}

.product.bpc-lx .pdp-slider.pdp-slider {
    margin-top: 0;
} 

  @media (max-width: 980px) {
    .product.bpc-lx .pdp-slider.pdp-slider {
        margin-bottom: 0;
    } 
}

.product.bpc-lx {
  background-color: #FEFFFE;
  padding-top: 0;
  padding-bottom: 48px;

  .container-1220.product-header {
    padding-inline: 32px;
  }

  .product-header {
    padding-block-start: 18px;
    padding-block-end: 16px;
  }

  .breadcrumb {
    margin-bottom: 10px;
    
    .breadcrumb-link {
      font-size: 14px;
      font-weight: normal;
      line-height: 20px; /* 142.857% */
      letter-spacing: 0.5px;
    }

    .breadcrumb-text {
      font-size: 14px;
      font-weight: normal;
      line-height: 20px; /* 142.857% */
      letter-spacing: 0.5px;
    }
  }

  .product-title {
    font-size: 32px;
    line-height: 40px !important;
    margin-bottom: 0 !important;
  }

  .product-description p {
    color: var(--txt-dark, #1A1B1B);
    font-size: 16px;
    line-height: 24px;
    letter-spacing: 0.5px;
  }

  .oke-sr-count {
    color: var(--txt-dark, #1A1B1B);
    font-size: 14px;
    line-height: 20px;
    letter-spacing: 0.5px;
    text-decoration: underline;
    text-underline-offset: 4px;
  }

  div[data-oke-star-rating] {
    margin-top: 8px;
  }

  .product-content {
    padding-inline: 0;
    row-gap: 24px;
    .swiper-button-next {
      display: none;
    }
    .swiper-button-prev {
      display: none;
    }

    .pdp-slider {
      margin-left: 0;
    }

    .pdp-slider .image-section,
    .pdp-slider .video-section {
      width: 100%;
      height: 390px;
    }

    .pdp-slider .swiper-slide {
      max-width: 100% !important;
      width: 100% !important;
    }

    .outer-pdp-thumbnail-slider {
      padding: 0;
    }

    .pdp-thumbnail .slide .image-section,
    .pdp-thumbnail .slide .video-section {
      width: 64px;
      height: 64px;
    }

    .pdp-thumbnail .slide .image-section {
      border-radius: 0;
    }

    .pdp-thumbnail .slide {
        width: 64px !important;
        height: 64px !important;
        margin-right: 0 !important;
    }

    .product__information {
        margin-top: 0;
        padding-inline: 32px;
    }

    .product-benefits_section_inner_content {
      display: flex;
      flex-direction: column;
      row-gap: 16px;
    }

    .product-benefits_section .inner-content .title {
      display: flex;
      column-gap: 16px;
      align-items: center;
      line-height: 24px;

      a {
        text-decoration: underline;
        text-underline-offset: 4px;
        font-weight: 400;
      }

      img {
        width: 24px;
        height: 24px;
      }
    }

    .product-benefits_section {
      margin-bottom: 24px;
    }
  }

  /* Hide desktop header on mobile */
  .product-header-desktop {
    display: none;
  }

  /* Show mobile header on mobile */
  .product-header-mobile {
    display: block;
  }

  /* Desktop: Show desktop header, hide mobile header */
  @media screen and (min-width: 1279px) {
    .product-header-desktop {
      display: block;
      padding-top: 0;

      .breadcrumb {
        margin-bottom: 26px;
      }

      .description.product-description {
          margin-top: 8px;
      }
    }

    .product-header-mobile {
      display: none;
    }

    .product-content {
      padding-top: 48px;
      display: grid;
      grid-template-columns: 720px 400px;
      column-gap: 32px;
      justify-content: center;
    }
  }
}

@media (min-width: 1279px) {
  .product.bpc-lx .product-content .pdp-slider .image-section,
  .product.bpc-lx .product-content .pdp-slider .video-section {
      width: 720px !important;
      height: 720px !important;
      max-height: 720px !important;
      border-radius: 16px 16px 0 0;
  }

  .product.bpc-lx .product__information.product__information {
    width: 100%;
    max-width: 100%;
    padding-inline: 0;
    position: sticky;
    top: 120px;
    align-self: start;
}

.product.bpc-lx .left-section {
    width: 100%;
}

.product.bpc-lx .product-content .pdp-thumbnail .slide .image-section,
.product.bpc-lx .product-content .pdp-thumbnail .slide .video-section {
    width: 358px !important;
    height: 358px !important;
}

.product.bpc-lx .product-content .pdp-thumbnail .slide {
    width: 358px !important;
    height: 358px !important;
}

.product.bpc-lx .product-content .pdp-slider .swiper-slide {
  max-width: 720px !important;
  width: 720px !important;
  margin-right: 12px !important;
}

.product.bpc-lx .left-section {
    max-height: 100%;
}

/* Desktop-only: 2-column vertical layout for thumbnails */
.product.bpc-lx .pdp-thumbnail {
    height: auto !important;
    gap: 4px;
}

/* Ensure Swiper wrapper works with grid layout - Desktop only */
.product.bpc-lx .js__pdp-thumbnail-slider {
    width: 100%;
    overflow: visible;
}

.product.bpc-lx .pdp-thumbnail-outer {
    width: 100%;
}

/* Make sure slides fit in grid - Desktop only */
.product.bpc-lx .pdp-thumbnail .swiper-slide {
    width: 100% !important;
    height: auto !important;
    margin: 0 !important;
    /* Prevent Swiper from overriding grid layout */
    flex-shrink: 0;
    flex-grow: 0;
}

/* Override Swiper's wrapper flex properties for grid - Desktop only */
.product.bpc-lx .pdp-thumbnail.swiper-wrapper {
    display: grid !important;
    grid-template-columns: repeat(2, 1fr);
    grid-auto-flow: row;
    flex-direction: unset !important;
    transform: none !important;
    width: 100% !important;
    max-width: 100%;
}

/* Adjust thumbnail container for vertical scrolling - Desktop only */
.product.bpc-lx .outer-pdp-thumbnail-slider {
    max-height: 720px;
    overflow-x: hidden;
    padding-right: 4px;
    position: relative;
    transition: max-height 0.3s ease-in-out;
    margin-bottom: 60px; /* Space for the toggle button */
}

/* Ensure gradient pseudo-element is always in DOM when grid is active */
@media (min-width: 1279px) {
  .product.bpc-lx .outer-pdp-thumbnail-slider::before {
    content: '';
  }
}

/* Collapsed state: Show only 4 thumbnails (2 rows x 2 columns) */
.product.bpc-lx .outer-pdp-thumbnail-slider.collapsed {
    max-height: calc(358px * 3 + 4px * 3); /* 3 rows: (thumbnail height * 3) + gaps between rows (2 gaps) */
    overflow: hidden;
}

/* Expanded state: Show all thumbnails without scroll */
.product.bpc-lx .outer-pdp-thumbnail-slider.expanded {
    max-height: none;
    overflow: visible;
    height: auto;
}

/* Gradient overlay - only present when grid is active */
/* .product.bpc-lx .outer-pdp-thumbnail-slider.grid-active::before {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    background: linear-gradient(0deg, #FEFFFE 25%, transparent);
    inset: 0;
    z-index: 2;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
} */

/* Show gradient when grid is active AND collapsed */
/* .product.bpc-lx .outer-pdp-thumbnail-slider.grid-active.collapsed::before {
    opacity: 1;
} */

/* Hide gradient when expanded */
/* .product.bpc-lx .outer-pdp-thumbnail-slider.grid-active.expanded::before {
    opacity: 0;
} */

/* Toggle button styles */
.product.bpc-lx .product-content {
    position: relative;
}

.product.bpc-lx .bpc-lx-thumbnail-toggle {
    position: absolute;
    bottom: -.5rem;
    left: 50%;
    transform: translateX(-50%);
    width: 56px;
    height: 56px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: none !important; /* Hidden by default - only show when grid is active */
    align-items: center;
    justify-content: center;
    z-index: 10;
    background-color: transparent;
    transition: bottom 0.3s ease-in-out;
    visibility: hidden; /* Additional hiding for extra safety */
    opacity: 0;
}

/* Show toggle button only when grid is active (handled by JavaScript) */
.product.bpc-lx .bpc-lx-thumbnail-toggle.grid-active {
    display: flex !important;
    visibility: visible !important;
    opacity: 1;
}

}

.product.bpc-lx .bpc-lx-thumbnail-toggle.expanded {
    bottom: -24px;
}

.product.bpc-lx .bpc-lx-thumbnail-toggle svg {
    width: 56px;
    height: 56px;
}

/* Show/hide icons based on state */
.product.bpc-lx .bpc-lx-thumbnail-toggle .toggle-icon-plus {
    display: block;
}

.product.bpc-lx .bpc-lx-thumbnail-toggle .toggle-icon-minus {
    display: none;
}

.product.bpc-lx .bpc-lx-thumbnail-toggle.expanded .toggle-icon-plus {
    display: none;
}

.product.bpc-lx .bpc-lx-thumbnail-toggle.expanded .toggle-icon-minus {
    display: block;
}

/* Custom scrollbar styling - Desktop only */
.product.bpc-lx .outer-pdp-thumbnail-slider::-webkit-scrollbar {
    width: 4px;
}

.product.bpc-lx .outer-pdp-thumbnail-slider::-webkit-scrollbar-track {
    background: transparent;
}

.product.bpc-lx .outer-pdp-thumbnail-slider::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 2px;
}

.product.bpc-lx .outer-pdp-thumbnail-slider::-webkit-scrollbar-thumb:hover {
    background: #999;
}

.product.bpc-lx .pdp-slider {
    margin-bottom: 4px;
  }

  /* Add to Cart button with arrow icon */
  .product.bpc-lx .btn--with-arrow {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .product.bpc-lx .btn-arrow-icon {
    flex-shrink: 0;
  }

  /* Supplement Facts Modal Styles - Matching Lity Modal */
  #modal-supplement-facts {
    z-index: 999999 !important;
    position: fixed;
    inset: 0;
    background: #0c264766;
    opacity: 0;
    transition: opacity 0.3s ease;
    padding: 20px;
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #modal-supplement-facts.modal-opened {
    opacity: 1;
  }

  #modal-supplement-facts .modal-content {
    margin: auto;
    overflow: visible;
    border-radius: 20px;
    width: 100%;
    max-width: 795px !important;
    max-height: 90vh;
    position: relative;
    z-index: 999990;
  }

  #modal-supplement-facts .close {
    display: block;
    position: absolute;
    top: 21px;
    right: 18px;
    z-index: 999991;
  }

  #modal-supplement-facts .supplement-facts-image-wrapper {
    border-radius: 20px;
    background-color: #FEFFFE;
    max-height: 90vh;
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #modal-supplement-facts .supplement-facts-image-wrapper img {
    max-width: 100%;
    max-height: 90vh;
    height: auto;
    width: auto;
    display: block;
    margin: 0 auto;
    object-fit: contain;
  }

  @media screen and (max-width: 768px) {
    #modal-supplement-facts {
      padding: 16px;
    }

    #modal-supplement-facts .modal-content {
      max-height: 95vh;
    }

    #modal-supplement-facts .supplement-facts-image-wrapper {
      max-height: 95vh;
    }

    #modal-supplement-facts .supplement-facts-image-wrapper img {
      max-height: 95vh;
    }

    #modal-supplement-facts .close {
      top: 8px;
      right: 8px;
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  }

{% endstylesheet %}
